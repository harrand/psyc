== default ==
{
	executable("xD");
	optimization(0);
	debug_symbols(true);
	assert(true);
	add_build_file("./src/libpsybase/src.psy");
	static_if(_win32)
	{
		add_link_library("Kernel32.lib");
	}
	prebuild_command("echo prebuild %cd%");
	postbuild_command("echo postbuild %cd%");
};

global_arena_val : arena mut := zero;
global_arena : arena mut? mut := zero;

// stores strings
string_arena_val : arena mut := zero;
string_arena : arena mut? mut := zero;

setup_arenas : func( -> v0)
{
	global_arena_val = arena_create_virtual_reserve(arena_default_reserve, 4096 * 1024);
	global_arena = ref global_arena_val;
	arena_auto_align(global_arena, 8);

	string_arena_val = arena_create_virtual_reserve(arena_default_reserve, 4096 * 1024);
	string_arena = ref string_arena_val;
	arena_auto_align(string_arena, 1);
};

memfill : func(dst : u8 mut? weak, byte : u8, len : u64 -> v0)
{
	i : u64 mut;
	for(i = 0; i < len; i = i + 1)
	{
		[dst # i] = byte;
	}
};

chungus : func(e : s32 -> v0)
{
	putsint(e);
};

colour : enum
{
	.red := 1;
	.blue := 2;
	.orange := 3;
};

FakeLLVMCreateTargetMachine : func(target : u64, triple : u8?, cpu : u8?, features : u8?, codegen_level : s32, code_reloc : s32, code_model : s32 -> u64 )
{
	return zero;
};

cool_t : struct
{
	xd : u64;
	foo : u64;
};

main : func(args : program_args? -> s32)
{
	setup_arenas();
	ptr : u8 mut? := arena_alloc(global_arena, sizeof u64 * 8192 * 1024);
	x : u64 weak static := 0;
	memfill(ptr, x, sizeof u64);
	uk : u8 mut;
	uk = 5;
	uk = zero;

	putzstr(zstr{.str := "hello, world!";});
	putchar(10);
	chungus(-1);
	fooey : colour := colour.blue;
	my_epic_constant ::= 69420;

	//my_epic_constant = zero;
	//my_epic_constant = 0;

	putchar(10);
	my_cool ::= cool_t mut
	{
		.xd := 5;
		... := zero;
	};

	myarr ::= u64[69]
	{
		.0 := 1;
		.1 := 2;
		.2 := 3;
		.3 := 4;
		... := zero;
	};
	i : u64 mut;
	putchar(10);
	putzstr(zstr{.str := "{";});
	putchar(10);
	for(i = 0; i < countof typeof myarr; i = i + 1)
	{
		putchar(9);
		putuint([myarr # i]);
		putchar(10);
	}
	putzstr(zstr{.str := "}";});
	putchar(10);
	
	putuint(my_cool.xd);
	//my_cool = zero;
	putuint(my_cool.xd);
	putchar(10);
	putzstr(zstr{.str := "uninit member: ";});
	putuint(my_cool.foo);
	putchar(10);

	return 0;
};
